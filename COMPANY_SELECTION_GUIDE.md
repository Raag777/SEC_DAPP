# Company Selection & Certificate Purchase Guide

## Overview

The Companies dashboard now supports selecting from multiple registered company accounts and displays purchased certificates with proper ID naming (C1_ID1, C2_ID1, etc.).

## What Changed

### 1. Backend Updates

#### certificates.service.js
- **Updated `purchaseCertificateService()`**: Now accepts `companyAddress` parameter
- **Dynamic signer**: Uses the correct company's private key to sign purchase transactions
- **Multi-company support**: Each company can now sign their own purchase transactions

#### certificates.controller.js
- **Added validation**: Requires `companyAddress` in request body
- **Pass-through**: Forwards company address to service layer

### 2. Frontend Updates

#### Companies.jsx
- **Company dropdown**: Select from registered companies (C1, C2, C3...)
- **Auto-fetch companies**: Loads from `/admin/companies` API
- **Certificate display**: Shows purchased certificates as C1_ID1, C2_ID3, etc.
- **Owned certificates view**: Displays all certificates purchased by the selected company
- **Purchase flow**: Automatically fetches certificate price and submits purchase request

## Certificate ID Naming for Purchases

The certificate IDs for purchased certificates are generated by the Merkle service:

### Pattern
- **Purchased by Company**: `C{companyIndex}_ID{certificateId}`
  - Example: C1_ID1, C2_ID5, C3_ID2

### How It Works
1. Producer P1 issues certificate → Gets ID 1 → Initially labeled **P1_ID1**
2. Company C1 purchases certificate ID 1 → Merkle service adds purchase event → Labeled **C1_ID1**
3. Producer P2 issues certificate → Gets ID 2 → Initially labeled **P2_ID2**
4. Company C2 purchases certificate ID 2 → Merkle service adds purchase event → Labeled **C2_ID2**

**Important**: The Merkle tree contains BOTH issuance and purchase events:
- Issuance event: `P1_ID1|txHash`
- Purchase event: `C1_ID1|txHash`

The `companyIndex` comes from the order in the `companyList` array in the smart contract.

## Testing Steps

### Step 1: Ensure System is Running

Make sure you have:
1. Hardhat node running
2. Contract deployed
3. Backend running
4. Frontend running

### Step 2: Register Companies in Admin Panel

1. Go to **Admin Panel** (http://localhost:5173/admin)
2. Register at least 3 companies using Hardhat test accounts:
   - **C1**: `0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC`
   - **C2**: `0x90F79bf6EB2c4f870365E785982E1f101E93b906`
   - **C3**: `0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65`

3. Verify they show as **C1, C2, C3** in the admin panel (green color)

### Step 3: Issue Certificates as Producers

Before companies can purchase, producers need to issue certificates:

1. Go to **Producers Dashboard** (http://localhost:5173/producers)
2. Select **P1** from dropdown
3. Issue certificate: Energy = 10 kWh → Certificate ID 1 created (**P1_ID1**)
4. Select **P2** from dropdown
5. Issue certificate: Energy = 15 kWh → Certificate ID 2 created (**P2_ID2**)
6. Select **P1** again
7. Issue certificate: Energy = 20 kWh → Certificate ID 3 created (**P1_ID3**)

### Step 4: Use Company Dashboard to Purchase Certificates

1. Go to **Companies Dashboard** (http://localhost:5173/companies)
2. You should see a dropdown: **"Select Company Account"**
3. The dropdown will show:
   ```
   C1: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
   C2: 0x90F79bf6EB2c4f870365E785982E1f101E93b906
   C3: 0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65
   ```

**As Company C1:**
1. Select **C1** from dropdown
2. Enter Certificate ID: `1`
3. Click **"Buy as C1"**
4. Wait for confirmation
5. Certificate ownership transferred → Labeled **C1_ID1** in Merkle tree

**As Company C2:**
1. Select **C2** from dropdown
2. Enter Certificate ID: `2`
3. Click **"Buy as C2"**
4. Certificate ownership transferred → Labeled **C2_ID2** in Merkle tree

**As Company C1 again:**
1. Select **C1** from dropdown
2. Enter Certificate ID: `3`
3. Click **"Buy as C1"**
4. Certificate ownership transferred → Labeled **C1_ID3** in Merkle tree

### Step 5: View Purchased Certificates

In the Companies dashboard, the **"Purchased Certificates"** section will show:

**For C1:**
- **C1_ID1**: 10 kWh, Price: 0.0001 ETH
- **C1_ID3**: 20 kWh, Price: 0.0001 ETH

**For C2:**
- **C2_ID2**: 15 kWh, Price: 0.0001 ETH

### Step 6: Verify Merkle Tree Labels

Check the Merkle tree endpoint to see both issuance and purchase events:

```bash
curl http://localhost:5000/merkle/tree
```

You should see leaves like:
```json
{
  "root": "0x...",
  "leaves": [
    "0x... (P1_ID1|0xISSUE_TX)",
    "0x... (C1_ID1|0xPURCHASE_TX)",
    "0x... (P2_ID2|0xISSUE_TX)",
    "0x... (C2_ID2|0xPURCHASE_TX)",
    "0x... (P1_ID3|0xISSUE_TX)",
    "0x... (C1_ID3|0xPURCHASE_TX)"
  ]
}
```

### Step 7: Demonstrate Multiple Transactions Per Block

With interval mining (5 seconds), you can demonstrate multiple purchases in one block:

1. **Quickly purchase 3 certificates** (within 5 seconds):
   - C1: Purchase certificate ID 4
   - C2: Purchase certificate ID 5
   - C3: Purchase certificate ID 6

2. **Check Hardhat console** - All 3 purchases should be in the same block:
   ```
   Block #5:
     Transaction 1: purchaseCertificate (C1 buys ID 4)
     Transaction 2: purchaseCertificate (C2 buys ID 5)
     Transaction 3: purchaseCertificate (C3 buys ID 6)
   ```

3. **Build Merkle tree** from all transactions in Block #5

## Complete Workflow Example

### Scenario: End-to-End Certificate Lifecycle

1. **Admin registers participants**:
   - Register P1, P2 (producers)
   - Register C1, C2, C3 (companies)

2. **Producers issue certificates**:
   - P1 issues Cert ID 1 (10 kWh) → **P1_ID1**
   - P2 issues Cert ID 2 (15 kWh) → **P2_ID2**
   - P1 issues Cert ID 3 (20 kWh) → **P1_ID3**

3. **Companies purchase certificates**:
   - C1 purchases ID 1 → **C1_ID1**
   - C2 purchases ID 2 → **C2_ID2**
   - C1 purchases ID 3 → **C1_ID3**

4. **Merkle tree contains**:
   ```
   Issuance Events:
   - P1_ID1 (P1 issued)
   - P2_ID2 (P2 issued)
   - P1_ID3 (P1 issued)

   Purchase Events:
   - C1_ID1 (C1 purchased)
   - C2_ID2 (C2 purchased)
   - C1_ID3 (C1 purchased)
   ```

5. **For your professor**:
   - Show that both issuance and purchase are tracked
   - Demonstrate multiple transactions in one block
   - Explain how Merkle tree verifies the entire history

## Architecture Diagram

```
Frontend (Companies.jsx)
    ↓
    Select Company (C1, C2, C3)
    ↓
    Enter Certificate ID to purchase
    ↓
    POST /certificates/purchase { id, valueWei, companyAddress }
    ↓
Backend (certificates.controller.js)
    ↓
    purchaseCertificateService(id, valueWei, companyAddress)
    ↓
Blockchain Service (blockchain.js)
    ↓
    getContractForProducer(companyAddress)
    ↓
    Contract signed with C1's private key
    ↓
Smart Contract (SolarEnergyCertificate.sol)
    ↓
    purchaseCertificate() - Transfers ownership, pays seller
    ↓
    Emits CertificatePurchased event
    ↓
Merkle Service (merkleService.js)
    ↓
    Queries CertificatePurchased events
    ↓
    Generates label: C{index}_ID{certId}
    ↓
    Adds to Merkle tree leaves
```

## Important Notes

1. **Certificate Price**
   - Price is set when the producer issues the certificate
   - Frontend automatically fetches the price before purchase
   - Company must pay exactly the certificate price (in wei)

2. **Ownership Transfer**
   - When a company purchases, ownership transfers from producer to company
   - Payment is automatically forwarded to the current owner (usually the producer)
   - The certificate ID doesn't change, only the owner changes

3. **Merkle Tree Structure**
   - Contains both issuance events (P1_ID1) and purchase events (C1_ID1)
   - Same certificate ID can appear twice: once for issuance, once for purchase
   - Each event has a unique transaction hash

4. **Company Index**
   - Company index (C1, C2, C3) is determined by registration order
   - First registered company = C1
   - Second registered company = C2
   - And so on...

## Troubleshooting

### "Company address is required"
- Make sure a company is selected from the dropdown
- Check browser console for API request payload

### "No private key found for company"
- Verify the company address is in the HARDHAT_ACCOUNTS array
- Make sure the address matches exactly (case-sensitive)

### "Insufficient payment"
- The certificate price is automatically fetched
- If you see this error, check if the certificate still exists and isn't retired

### Dropdown is empty
- Ensure companies are registered in Admin panel
- Check backend API: `GET /admin/companies`
- Restart backend if needed

### Certificate already purchased
- You can't purchase a certificate you already own
- Check the "Purchased Certificates" section to see what you own

### Purchased certificates not showing
- Make sure the company actually purchased certificates
- Refresh the page to reload data
- Check the blockchain explorer to verify the purchase transaction

## For Your Professor

When demonstrating to your professor, show:

1. **Registration**: Register multiple producers (P1, P2) and companies (C1, C2, C3)
2. **Issuance**: Producers issue certificates (P1_ID1, P2_ID2, etc.)
3. **Purchase**: Companies purchase certificates (C1_ID1, C2_ID2, etc.)
4. **Block grouping**: Show multiple transactions in one block (within 5 seconds)
5. **Merkle tree**: Display the tree with both issuance and purchase events
6. **Verification**: Generate and verify Merkle proofs for any transaction

This demonstrates:
- Complete certificate lifecycle (issue → purchase)
- Multiple participants (producers and companies)
- Blockchain transaction grouping
- Merkle tree construction from multiple transaction types
- Cryptographic verification of certificate history

## Summary

✅ **Company selector**: Choose from C1, C2, C3...
✅ **Purchase certificates**: Buy certificates with proper company signature
✅ **Certificate labeling**: Purchased certificates labeled as C1_ID1, C2_ID2, etc.
✅ **Ownership tracking**: View all certificates owned by each company
✅ **Merkle tree**: Both issuance and purchase events included
✅ **Multiple transactions per block**: Demonstrate blockchain efficiency

The system now fully supports the complete Solar Energy Certificate lifecycle with proper tracking and verification!
